<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="renderer" content="webkit">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=10; IE=9; IE=8; IE=7;  IE=EDGE">
    
    <title>告警回调接口使用说明 &mdash; 文档中心</title>
    
<link rel="stylesheet" href="_static/css/docsv2.css" type="text/css" />
    
<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
    };
</script>
<script type="text/javascript" src="_static/docsv2.min.js"></script>
</head>
<body role="document">
<div class="bglayer docs">
    <div class="main">
        <div class="sub-main">
            <div class="content-wrap docs">
                <div class="document clearfix">
                    <div class="localtoc-wrap">
                        <ul>
<li><a class="reference internal" href="#">告警回调接口使用说明</a><ul>
<li><a class="reference internal" href="#webhook">WebHook说明</a><ul>
<li><a class="reference internal" href="#id2">先决条件</a></li>
<li><a class="reference internal" href="#json-boday-example">JSON Boday Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#webhookserver-demo">WebHookServer Demo 编译、安装</a><ul>
<li><a class="reference internal" href="#id3">依赖外部环境</a></li>
<li><a class="reference internal" href="#id4">准备工作</a></li>
<li><a class="reference internal" href="#id5">部署代码</a></li>
<li><a class="reference internal" href="#id6">配置</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7">客户端说明</a></li>
<li><a class="reference internal" href="#id8">资源路径及接口</a></li>
</ul>
</li>
</ul>

                    </div>
                    
                                <div class="body" role="main">
                                    
  <div class="section" id="id1">
<h1>告警回调接口使用说明<a class="headerlink" href="#id1" title="永久链接至标题">§</a></h1>
<p>将公网可访问到的http服务地址作为回调地址，当触发告警时，监控中心会将告警推送到该地址。</p>
<div class="section" id="webhook">
<h2>WebHook说明<a class="headerlink" href="#webhook" title="永久链接至标题">§</a></h2>
<p>创建webhook后您的系统可以收到UCloud告警信息。当有告警时，UCloud的系统会将告警信息以HTTP POST方式发送到指定URL，您可以对收到信息进行处理。</p>
<div class="section" id="id2">
<h3>先决条件<a class="headerlink" href="#id2" title="永久链接至标题">§</a></h3>
<p>用户需要提供接收POST请求的HTTP服务，以处理UCloud发送的POST请求，并将该服务的URL注册到UCloud的告警系统中。</p>
</div>
<div class="section" id="json-boday-example">
<h3>JSON Boday Example<a class="headerlink" href="#json-boday-example" title="永久链接至标题">§</a></h3>
<p><em>告警</em></p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="n">SessionID</span><span class="p">:</span> <span class="s">&quot;xxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">,</span>
    <span class="n">Region</span><span class="p">:</span> <span class="s">&quot; cn-north-03&quot;</span><span class="p">,</span>
    <span class="n">ResourceType</span><span class="p">:</span> <span class="s">&quot;uhost&quot;</span><span class="p">,</span>
    <span class="n">ResourceId</span><span class="p">:</span> <span class="s">&quot;uhost-xxxx&quot;</span><span class="p">,</span>
    <span class="n">MetricName</span><span class="p">:</span> <span class="s">&quot;MemUsage&quot;</span><span class="p">,</span>
    <span class="n">AlarmTime</span><span class="p">:</span> <span class="mi">1458733318</span><span class="p">,</span>
    <span class="n">RecoveryTime</span> <span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
<p><em>恢复</em></p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="n">SessionID</span><span class="p">:</span> <span class="s">&quot;xxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">,</span>
    <span class="n">Region</span><span class="p">:</span> <span class="s">&quot;cn-north-03&quot;</span><span class="p">,</span>
    <span class="n">ResourceType</span><span class="p">:</span> <span class="s">&quot;uhost&quot;</span><span class="p">,</span>
    <span class="n">ResourceId</span><span class="p">:</span> <span class="s">&quot;uhost-xxxx&quot;</span><span class="p">,</span>
    <span class="n">MetricName</span><span class="p">:</span> <span class="s">&quot;MemUsage&quot;</span><span class="p">,</span>
    <span class="n">AlarmTime</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">RecoveryTime</span><span class="p">:</span> <span class="mi">1458733318</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Field Explaination</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Explaination</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>SessionID</td>
<td>Session ID for this message</td>
</tr>
<tr class="row-odd"><td>Region</td>
<td>Region Name</td>
</tr>
<tr class="row-even"><td>ResourceType</td>
<td>Resource Type</td>
</tr>
<tr class="row-odd"><td>MetricName</td>
<td>Metric Name for current warning</td>
</tr>
<tr class="row-even"><td>AlarmTime</td>
<td>Alarm time</td>
</tr>
<tr class="row-odd"><td>RecoveryTime</td>
<td>Restory time</td>
</tr>
<tr class="row-even"><td>Content</td>
<td>Warning content</td>
</tr>
</tbody>
</table>
<p><em>Response</em></p>
<p>我们这边需要收到这样的response， 表明用户成功接收推送信息，否则会再重试2次：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="n">SessionID</span><span class="p">:</span> <span class="s">&quot;xxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">,</span>
    <span class="n">RetCode</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="webhookserver-demo">
<h2>WebHookServer Demo 编译、安装<a class="headerlink" href="#webhookserver-demo" title="永久链接至标题">§</a></h2>
<p>本Demo提供实现支持WebHook服务的一种方式，基于Golang实现，使用MySQL存储收到的报警数据，Demo仅供参考。 下面以UHost及UDB为例介绍如何使用该Demo。</p>
<div class="section" id="id3">
<h3>依赖外部环境<a class="headerlink" href="#id3" title="永久链接至标题">§</a></h3>
<p>根据UCloud相关操作说明创建系统为CentOS的UHost</p>
<div class="highlight-python"><div class="highlight"><pre>弹性IP: 106.75.49.79 BGP 2 Mb
外网防火墙: Web服器推荐(22，3389，80，443)
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>准备工作<a class="headerlink" href="#id4" title="永久链接至标题">§</a></h3>
<ol class="arabic simple">
<li>安装数据库</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># yum install mysql mysql-server -y</span>
<span class="c"># service mysqld start</span>
<span class="c"># chkconfig mysqld on</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>创建名为monitor_warn的数据库，并实用以下表结构</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre># mysql
# CREATE DATABASE `monitor_warn`;
# USE monitor_warn
# CREATE TABLE IF NOT EXISTS `warn_message` (
    `session_id` char(36) NOT NULL,
    `region` varchar(20) NOT NULL,
    `resource_type` varchar(45) NOT NULL,
    `resource_id` varchar(45) NOT NULL,
    `metric_name` varchar(50) NOT NULL,
    `alarm_time` int(11) DEFAULT NULL,
    `recovery_time` int(11) DEFAULT &#39;0&#39;,
    PRIMARY KEY (`session_id`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>配置Golang编译环境</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># yum install golang -y</span>
<span class="c"># mkdir /usr/local/golang</span>
</pre></div>
</div>
<p>修改~/.bashrc，添加如下内容:</p>
<div class="highlight-python"><div class="highlight"><pre>export GOPATH=/usr/local/golang
export PATH=$PATH:$GOPATH/bin
</pre></div>
</div>
<p>加载已配置环境变量</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># sorce ~/.bashrc</span>
</pre></div>
</div>
<p>查看已配置go环境变量</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># go env</span>
<span class="n">GOARCH</span><span class="o">=</span><span class="s">&quot;amd64&quot;</span>
<span class="n">GOBIN</span><span class="o">=</span><span class="s">&quot;&quot;</span>
<span class="n">GOEXE</span><span class="o">=</span><span class="s">&quot;&quot;</span>
<span class="n">GOHOSTARCH</span><span class="o">=</span><span class="s">&quot;amd64&quot;</span>
<span class="n">GOHOSTOS</span><span class="o">=</span><span class="s">&quot;linux&quot;</span>
<span class="n">GOOS</span><span class="o">=</span><span class="s">&quot;linux&quot;</span>
<span class="n">GOPATH</span><span class="o">=</span><span class="s">&quot;/usr/local/golang&quot;</span>
<span class="n">GORACE</span><span class="o">=</span><span class="s">&quot;&quot;</span>
<span class="n">GOROOT</span><span class="o">=</span><span class="s">&quot;/usr/lib/golang&quot;</span>
<span class="n">GOTOOLDIR</span><span class="o">=</span><span class="s">&quot;/usr/lib/golang/pkg/tool/linux_amd64&quot;</span>
<span class="n">GO15VENDOREXPERIMENT</span><span class="o">=</span><span class="s">&quot;&quot;</span>
<span class="n">CC</span><span class="o">=</span><span class="s">&quot;gcc&quot;</span>
<span class="n">GOGCCFLAGS</span><span class="o">=</span><span class="s">&quot;-fPIC -m64 -pthread -fmessage-length=0&quot;</span>
<span class="n">CXX</span><span class="o">=</span><span class="s">&quot;g++&quot;</span>
<span class="n">CGO_ENABLED</span><span class="o">=</span><span class="s">&quot;1&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>安装Golang第三方依赖包</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># yum install git -y</span>
<span class="c"># go get github.com/gorilla/mux</span>
<span class="c"># go get github.com/google/uuid</span>
<span class="c"># go get github.com/go-sql-driver/mysql</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>部署代码<a class="headerlink" href="#id5" title="永久链接至标题">§</a></h3>
<ol class="arabic simple">
<li>从github上将代码复制到本地</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre>git clone git@github.com:ucloud/umon_webhook.git
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>在目录warn-webhook中创建名为src指向webhook-demo-go的软连接</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd warn-webhook</span>
<span class="c"># ln -s $PWD/webhook-demo-go src</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>将目录warn-webhook添加到GOPATH中</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># export GOPATH=$GOPATH:$PWD</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>在目录webhook-demo-go中编译</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd webhook-demo-go</span>
<span class="c"># go build -a .</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>配置<a class="headerlink" href="#id6" title="永久链接至标题">§</a></h3>
<ol class="arabic simple">
<li>根据数据库表相关信息，修改webhook-demo-go/etc/conf.ini</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&quot;api-port&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
    <span class="s">&quot;mysql-user&quot;</span><span class="p">:</span> <span class="s">&quot;root&quot;</span><span class="p">,</span>
    <span class="s">&quot;mysql-passwd&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
    <span class="s">&quot;mysql-db&quot;</span><span class="p">:</span> <span class="s">&quot;monitor_warn&quot;</span><span class="p">,</span>
    <span class="s">&quot;mysql-host&quot;</span><span class="p">:</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="s">&quot;mysql-port&quot;</span><span class="p">:</span> <span class="mi">3306</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>执行编译生成的课执行程序webhook-demo-go，默认加载etc/conf.ini文件，也可以指定其他位置配置文件</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre># ./webhook-demo-go &amp;
2016/08/10 16:58:25 Welcome to ucloud monitor webhook demo ...
2016/08/10 16:58:25 Monitor webhook demo use 2 process cores
2016/08/10 16:58:25 Start monitor warn webhook server ...
2016/08/10 16:58:25 Webhook Server listen on : :80
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">webhook-demo-go 可使用-c参数指定配置文件路径</p>
</div>
</div>
</div>
<div class="section" id="id7">
<h2>客户端说明<a class="headerlink" href="#id7" title="永久链接至标题">§</a></h2>
<p>用于测试添加报警信息，实际数据以接口实际返回为准，具体操作如下：</p>
<div class="highlight-python"><div class="highlight"><pre># cd warn-webhook
# go build ./webhook-client.go
# ./webhook-client -u http://$IP/add
-&gt; webhook post url
Post request for webhook:  0
{&quot;SessionID&quot;:&quot;07a89fb8-5ee0-11e6-b059-00ffbeabee13&quot;,&quot;Region&quot;:&quot;cn-north-03&quot;,&quot;Reso
urceType&quot;:&quot;uhost&quot;,&quot;ResourceId&quot;:&quot;uhost-xxxx&quot;,&quot;MetricName&quot;:&quot;MemUsage&quot;,&quot;AlarmTime&quot;:
1470822697,&quot;RecoveryTime&quot;:0}
......
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">$IP为外网IP地址</p>
</div>
</div>
<div class="section" id="id8">
<h2>资源路径及接口<a class="headerlink" href="#id8" title="永久链接至标题">§</a></h2>
<ol class="arabic simple">
<li>访问$IP地址，默认端口为80</li>
</ol>
<img alt="webhook0.png" src="img/webhook0.jpg" />
<ol class="arabic simple" start="2">
<li>访问/get，获取当前已经添加的报警信息</li>
</ol>
<img alt="webhook1.png" src="img/webhook1.jpg" />
</div>
</div>


                                </div>
                            </div>
<div class="related clearfix" role="navigation" aria-label="related navigation">
    <ul>
        <li class="mail-feedback left">
            文档有误？发送邮件反馈给我们。
            <a href="#">UQAFeedback@ucloud.cn</a>
        </li>
    </ul>
</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer" role="contentinfo" style="display: none;">
    </div>
    <div class="service-tool">
        <div class="content">
            <a href="#service-tool-support" class="J_service-tool-link">
                <div class="link-wrap">
                    <span class="icon__wechat"></span>
                </div>
            </a>
            <a target="_blank" href="https://beianv2.ucloud.cn/">
                <div class="link-wrap">
                    <span class="icon__urecord"></span>
                </div>
            </a>
            <a href="#service-tool-qrcode" class="J_service-tool-link">
                <div class="link-wrap">
                    <span class="icon__qr-code"></span>
                    <div class="service-tool-tips qrcode" id="service-tool-qrcode">
                        <span class="service-caret"></span>
                        <div class="content-wrapper">
                            <img src="https://static.ucloud.cn/e501a1c02fae3c2c609a54725ac889be.jpg" alt=""/>
                        </div>
                    </div>
                </div>
            </a>
            <div class="link-wrap back-to-top">
                <span class="icon__arrow-up"></span>
            </div>
            <div class="service-tool-tips support" id="service-tool-support">
                <span class="service-caret"></span>
                <div class="content-wrapper">
                    <div class="content-cell blue">
                        <p class="title">
                            <span class="title-line"></span>
                            售前咨询
                        </p>
                        <a class="detail" href="https://www.ucloud.cn/site/support/" target="_blank">更多 > </a>
                        <a class="bottom-part" href="http://b.qq.com/webc.htm?new=0&sid=4000188113&eid=218808P8z8p8x8Q808Q8Q&o=http://www.ucloud.cn&q=7&ref=http://www.ucloud.cn/help" target="_blank">线上咨询（5x9h）</a>
                    </div>
                    <span class="tips-division"></span>
                    <div class="content-cell purple">
                        <p class="title">
                            <span class="title-line"></span>
                            售后咨询
                        </p>
                        <a class="detail" href="https://www.ucloud.cn/site/support/" target="_blank">更多 > </a>
                        <a class="bottom-part" href="https://accountv2.ucloud.cn/work_ticket" target="_blank">提交工单（7x24h）</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="page-footer-wrap">
        <div class="page-footer-copyright">
            Copyright © 2012-2016 UCloud 上海优刻得信息科技有限公司 ｜<a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action" target="_blank">沪ICP备 12020087</a>
        </div>
    </div>
</body>
</html>